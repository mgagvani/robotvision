Using bfloat16 Automatic Mixed Precision (AMP)
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/callbacks/model_checkpoint.py:881: Checkpoint directory /scratch/gilbreth/shar1159/checkpoints exists and is not empty.
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/utilities/model_summary/model_summary.py:242: Precision bf16-mixed is not supported by the model summary.  Estimated model size in MB will not be accurate. Using 32 bits instead.

  | Name  | Type     | Params | Mode  | FLOPs
---------------------------------------------------
0 | model | NewModel | 28.1 M | train | 0    
---------------------------------------------------
1.3 M     Trainable params
26.8 M    Non-trainable params
28.1 M    Total params
112.541   Total estimated model params size (MB)
244       Modules in train mode
0         Modules in eval mode
0         Total Flops
SLURM auto-requeueing enabled. Setting signal handlers.
/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/utilities/data.py:123: Your `IterableDataset` has `__len__` defined. In combination with multi-process data loading (when num_workers > 1), `__len__` could be inaccurate if each worker is not configured independently to avoid having duplicate data.
Traceback (most recent call last):
  File "/scratch/gilbreth/shar1159/robotvision/src/camera-based-e2e/train.py", line 104, in <module>
    trainer.fit(lit_model, train_loader, val_loader)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py", line 584, in fit
    call._call_and_handle_interrupt(
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py", line 49, in _call_and_handle_interrupt
    return trainer_fn(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py", line 630, in _fit_impl
    self._run(model, ckpt_path=ckpt_path, weights_only=weights_only)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py", line 1079, in _run
    results = self._run_stage()
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py", line 1121, in _run_stage
    self._run_sanity_check()
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py", line 1150, in _run_sanity_check
    val_loop.run()
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py", line 179, in _decorator
    return loop_run(self, *args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py", line 146, in run
    self._evaluation_step(batch, batch_idx, dataloader_idx, dataloader_iter)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py", line 441, in _evaluation_step
    output = call._call_strategy_hook(trainer, hook_name, *step_args)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py", line 329, in _call_strategy_hook
    output = fn(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/pytorch_lightning/strategies/strategy.py", line 412, in validation_step
    return self.lightning_module.validation_step(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/robotvision/src/camera-based-e2e/models/shrey_model.py", line 58, in validation_step
    pred = self(batch)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/robotvision/src/camera-based-e2e/models/shrey_model.py", line 37, in forward
    return self.model(x)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/robotvision/src/camera-based-e2e/models/shrey_model.py", line 181, in forward
    cam_feats = self.features(larger_tensor)[0]
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py", line 632, in _fn
    return fn(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/robotvision/src/camera-based-e2e/models/shrey_model.py", line 145, in forward
    feats = self.sam_model(x_t)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/timm/models/_features.py", line 476, in forward
    features = self.model.forward_intermediates(
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/timm/models/hieradet_sam2.py", line 513, in forward_intermediates
    x = blk(x)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/timm/models/hieradet_sam2.py", line 213, in forward
    x = self.attn(x)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
  File "/scratch/gilbreth/shar1159/conda_envs/waymo/lib/python3.10/site-packages/timm/models/hieradet_sam2.py", line 118, in forward
    x = F.scaled_dot_product_attention(q, k, v)
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 7.04 GiB. GPU 0 has a total capacity of 15.77 GiB of which 4.57 GiB is free. Including non-PyTorch memory, this process has 11.19 GiB memory in use. Of the allocated memory 10.62 GiB is allocated by PyTorch, and 215.51 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
srun: error: gilbreth-e011: task 0: Exited with exit code 1
